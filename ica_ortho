#!/bin/bash
# Render thresholded zstat images for a tensor PICA analysis on anatomy
#
# USAGE: icaortho gica_dir ic_num x y z
#
# ARGS:
# gica_dir = Group ICA directory generated by Melodic
# ic_num = Number of IC to render
# x, y, z = Voxel coordinates of orthoslice intersection
# outdir = output directory for orthoslice montages
# prefix = short group prefix string for output files
#
# AUTHOR : Mike Tyszka
# PLACE  : Caltech
# DATES  : 03/10/2010 JMT From scratch
#          12/03/2010 JMT Make single-IC specific for batching
#
# Copyright 2010 California Institute of Technology
# All rights reserved.

# Operational flags
do_neg_ica=0

if [ $# -lt 7 ]; then

  echo ------------------------------------------
  echo Render thresholded zstat images for a tensor PICA analysis on anatomy
  echo
  echo USAGE: icaorth gica_dir ic_num x y z prefix
  echo
  echo ARGS:
  echo gica_dir = Group ICA directory generated by Melodic
  echo ic_num = Number of IC to render
  echo x, y, z = Voxel coordinates of orthoslice intersection
  echo outdir = output directory for orthoslice montages
  echo prefix = short group prefix string for output files
  echo ------------------------------------------
  exit
fi

# Parse arguments
gica_dir=$1
ic=$2
x=$3
y=$4
z=$5
outdir=$6
prefix=$7

# Stats directory
stats_dir=${gica_dir}/groupmelodic.ica/stats

if [ ! -d $stats_dir ]; then
  echo gica_dir/groupmelodic.ica/stats directory is missing
  exit
fi

if [ ! -d $outdir ]; then
  echo Creating output directory
  mkdir -p $outdir
fi

# Background T1 anatomy
bg=${gica_dir}/bg_image.nii.gz

# Background image must exist
if [ ! -s $bg ]; then
  echo "$bg not found - exiting"
  exit
fi

# Background image limits
bg_lims=`fslstats $bg -r`

echo Background image: $bg $bg_lims

# Brain mask
mask=${gica_dir}/mask.nii.gz

# File stub for thresholded z-score images
thz_stub=thresh_zstat

# Thresholded z-score image
thz=${stats_dir}/${thz_stub}${ic}

# Thresholded zstat overlay filename
overlay=${outdir}/${thz_stub}_overlay.nii.gz

# Find minimum (threshold) and maximum of thz
# thz_lims=`fslstats $thz -l 0.0 -R`

# Force constant z-score colorscale range
thz_lims="0.5 12.0"

echo Thresholded z-score range : $thz_lims

# Create overlay Nifti volume image
echo Creating color overlay
overlay 1 1 $bg $bg_lims $thz $thz_lims $overlay

echo Extracting orthoslices from color overlay
ortho=${outdir}/ortho_${prefix}${ic}
ortho_x=${ortho}_x.png
ortho_y=${ortho}_y.png
ortho_z=${ortho}_z.png

slicer $overlay -l render1t -u -t -n -x -$x $ortho_x
slicer $overlay -l render1t -u -t -n -y -$y $ortho_y
slicer $overlay -l render1t -u -t -n -z -$z $ortho_z

echo Montaging slices into tryptic
montage -geometry +0+0 -tile 3x1 $ortho_x $ortho_y $ortho_z ${ortho}.png

# Cleanup
echo Cleaning up
rm -rf $overlay $ortho_x $ortho_y $ortho_z
