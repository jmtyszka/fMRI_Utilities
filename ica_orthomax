#!/bin/bash
# Render thresholded zstat images for a tensor PICA analysis on anatomy
# Center orthoslice on maximum location of zstat
#
# USAGE: icaortho gica_dir ic_num
#
# ARGS:
# gica_dir = Group ICA directory generated by Melodic
# ic_num = Number of IC to render
#
# AUTHOR : Mike Tyszka
# PLACE  : Caltech
# DATES  : 03/10/2010 JMT From scratch
#          12/03/2010 JMT Make single-IC specific for batching
#          12/10/2010 JMT Adapt for max zstat cursor
#
# Copyright 2010 California Institute of Technology
# All rights reserved.

# Operational flags
do_neg_ica=0

if [ $# -lt 2 ]; then

  echo ------------------------------------------
  echo Render thresholded zstat images for a tensor PICA analysis on anatomy
  echo Center orthoslices at maximum threshold z-stat location
  echo
  echo USAGE: icaorth gica_dir ic_num
  echo
  echo ARGS:
  echo gica_dir = Group ICA directory generated by Melodic
  echo ic_num = Number of IC to render
  echo ------------------------------------------
  exit
fi

# Parse arguments
gica_dir=$1
ic=$2

# Stats directory
stats_dir=${gica_dir}/groupmelodic.ica/stats

if [ ! -d $stats_dir ]; then
  echo gica_dir/groupmelodic.ica/stats directory is missing
  exit
fi

# Output directory
ortho_dir=${gica_dir}/ortho

if [ ! -d $ortho_dir ]; then
  echo Creating ortho directory
  mkdir -p $ortho_dir
fi

# Background T1 anatomy
bg=${gica_dir}/bg_image.nii.gz
bg_lims="700 1400"

# Brain mask
mask=${gica_dir}/mask.nii.gz

# File stub for thresholded z-score images
thz_stub=thresh_zstat

# Thresholded z-score image
thz=${stats_dir}/${thz_stub}${ic}

# Thresholded zstat overlay filename
overlay=${ortho_dir}/${thz_stub}_overlay.nii.gz

# Find range of thz
thz_lims=`fslstats $thz -l 0.0 -R`
echo Thresholded z-score range : $thz_lims

# Find location of thz maximum
maxloc=`fslstats $thz -x`
x=`echo $maxloc | awk '{ print $1 }'`
y=`echo $maxloc | awk '{ print $2 }'`
z=`echo $maxloc | awk '{ print $3 }'`
echo Maximum threshold z-stat at \($x,$y,$z\)

# Create overlay Nifti volume image
echo Creating color overlay
overlay 1 1 $bg $bg_lims $thz $thz_lims $overlay

echo Extracting orthoslices from color overlay
ortho=${ortho_dir}/ortho_${ic}
ortho_x=${ortho}_x.png
ortho_y=${ortho}_y.png
ortho_z=${ortho}_z.png

slicer $overlay -l render1t -u -t -n -x -$x $ortho_x
slicer $overlay -l render1t -u -t -n -y -$y $ortho_y
slicer $overlay -l render1t -u -t -n -z -$z $ortho_z

echo Montaging slices into tryptic
montage -geometry +0+0 -tile 3x1 $ortho_x $ortho_y $ortho_z ${ortho}.png

# Cleanup
echo Cleaning up
rm -rf $overlay $ortho_x $ortho_y $ortho_z
