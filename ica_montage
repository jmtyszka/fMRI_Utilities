#!/bin/bash
#
# Render thresholded zstat images for a tensor PICA analysis on anatomy
# This script should be run from a *.gica/groupmelodic.ica/stats directory generated by Melodic
#
# Mike Tyszka 3/10/2010

# Background T1 anatomy
bg="../../bg_image.nii.gz"

# Count the number of volumes to render
nvols=`ls thresh_zstat*.nii.gz | wc -l`

# Init row image list
all_rows=""

for (( vc=1; vc<=$nvols; vc++ ))
do

  echo Volume $vc

  # Thresholded zstat volume name
  thz=thresh_zstat${vc}.nii.gz

  # Rendered Nifti zstat image 
  overlay=rend_zstat${vc}.nii.gz

  # Image row for a given volume
  row=row_zstat${vc}.png

  # Final rendered montage
  montage=mont_zstat.png

  # Determine positive and negative thresholds used by Melodic
  echo Determining positive and negative z-score ranges
  pos_rng=`fslstats $thz -l 0.0 -R`
  neg_rng=`fslstats $thz -u 0.0 -R`

  # Extract pos and neg limits
  pos_min=`echo $pos_rng | awk '{ print $1 }'`
  pos_max=`echo $pos_rng | awk '{ print $2 }'`
  neg_min=`echo $neg_rng | awk '{ print $1 }'`
  neg_max=`echo $neg_rng | awk '{ print $2 }'`

  pos_same=`expr $pos_min == $pos_max`
  if [ "$pos_same" -eq "1" ]; then
    echo Zero positive range - correcting
    pos_min=0.001
    pos_max=0.002
  fi

  neg_same=`expr $neg_min == $neg_max`
  if [ "$neg_same" -eq "1" ]; then
    echo Zero negative range - correcting
    neg_min=-0.002
    neg_max=-0.001
  fi

  echo Positive range : $pos_min $pos_max
  echo Negative range : $neg_max $neg_min

  # Create overlay Nifti volume image with pos and neg zstats
  echo Overlaying in $overlay

  echo overlay 1 0 $bg 0 1500 $thz $pos_min $pos_max $thz $neg_max $neg_min $overlay
  overlay 1 0 $bg 0 1500 $thz $pos_min $pos_max $thz $neg_max $neg_min $overlay

  # Create horizontal montage of every 4 slice in volume
  echo Creating row in $row
  slicer $overlay -u -t -n -S 4 2000 $row

  # Add current row image name to running total
  all_rows="$all_rows $row"

done 

# Create final montage of all ICs
echo Creating final montage
montage -geometry +0+0 -tile 1x${nvols} $all_rows $montage
